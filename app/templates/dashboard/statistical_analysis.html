{% extends 'base.html' %}
{% load static %}

{% block title %}Statistical Analysis - EcoGenomics Suite{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="etfash-logo">
                        <img src="{% static 'images/etfash-logo.jpeg' %}" alt="ETfash Logo" class="w-full h-full rounded-lg">
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold brand-text">EcoGenomics Suite</h1>
                        <p class="text-sm text-gray-600">Statistical Analysis</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">Welcome, {{ user.username }}</span>
                    <a href="{% url 'dashboard' %}" class="text-emerald-600 hover:text-emerald-700 text-sm font-medium">Dashboard</a>
                    <a href="{% url 'logout' %}" class="text-gray-600 hover:text-gray-700 text-sm">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Breadcrumb -->
        <nav class="flex mb-8" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="{% url 'dashboard' %}" class="text-gray-700 hover:text-emerald-600 inline-flex items-center">
                        <i class="fas fa-home w-4 h-4 mr-2"></i>
                        Dashboard
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 w-4 h-4"></i>
                        <span class="ml-1 text-gray-500 md:ml-2">Statistical Analysis</span>
                    </div>
                </li>
            </ol>
        </nav>

        <!-- Analysis Interface -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Analysis Controls -->
            <div class="lg:col-span-1">
                <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                    <div class="px-6 py-4 bg-gradient-to-r from-purple-500 to-indigo-500">
                        <h2 class="text-xl font-semibold text-white flex items-center">
                            <i class="fas fa-chart-line mr-3"></i>
                            Analysis Controls
                        </h2>
                    </div>

                    <div class="p-6 space-y-6">
                        <!-- Analysis Type Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Analysis Type</label>
                            <select id="analysisType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="">Select Analysis Type</option>
                                <option value="descriptive">Descriptive Statistics</option>
                                <option value="t_test">T-Test Analysis</option>
                                <option value="anova">ANOVA Analysis</option>
                                <option value="correlation">Correlation Analysis</option>
                                <option value="trend">Trend Analysis</option>
                                <option value="compliance">Compliance Analysis</option>
                                <option value="multivariate">Multivariate Analysis</option>
                            </select>
                        </div>

                        <!-- Data Filters -->
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Data Filters</h3>
                            
                            <!-- Pollutants Filter -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pollutants</label>
                                <select id="pollutantFilter" multiple class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500" size="4">
                                    {% for pollutant in pollutants %}
                                        <option value="{{ pollutant.id }}">{{ pollutant.name }}</option>
                                    {% endfor %}
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
                            </div>

                            <!-- Locations Filter -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Locations</label>
                                <select id="locationFilter" multiple class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500" size="4">
                                    {% for location in locations %}
                                        <option value="{{ location.id }}">{{ location.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Date Range Filter -->
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                                    <input type="date" id="dateFrom" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                                    <input type="date" id="dateTo" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                            </div>

                            <!-- Batches Filter -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sample Batches</label>
                                <select id="batchFilter" multiple class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500" size="3">
                                    {% for batch in batches %}
                                        <option value="{{ batch.id }}">{{ batch.name }} ({{ batch.sampling_date }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Analysis-Specific Options -->
                        <div id="analysisOptions" class="border-t pt-6 hidden">
                            <!-- Trend Analysis Options -->
                            <div id="trendOptions" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Time Period</label>
                                <select id="timePeriod" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly" selected>Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>

                            <!-- T-Test Options -->
                            <div id="ttestOptions" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Test Type</label>
                                <select id="testType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                                    <option value="independent">Independent Samples</option>
                                    <option value="paired">Paired Samples</option>
                                </select>
                            </div>
                        </div>

                        <!-- Run Analysis Button -->
                        <button id="runAnalysis" class="w-full px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-md hover:from-purple-600 hover:to-indigo-600 transition-colors flex items-center justify-center">
                            <i class="fas fa-play mr-2"></i>
                            Run Analysis
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Display -->
            <div class="lg:col-span-2">
                <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                    <div class="px-6 py-4 bg-gradient-to-r from-emerald-500 to-cyan-500">
                        <h2 class="text-xl font-semibold text-white flex items-center">
                            <i class="fas fa-chart-bar mr-3"></i>
                            Analysis Results
                        </h2>
                    </div>

                    <div class="p-6">
                        <!-- Loading State -->
                        <div id="loadingState" class="hidden text-center py-12">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500"></div>
                            <p class="mt-4 text-gray-600">Running statistical analysis...</p>
                        </div>

                        <!-- Initial State -->
                        <div id="initialState" class="text-center py-12">
                            <div class="mx-auto w-24 h-24 text-gray-400 mb-4">
                                <i class="fas fa-chart-line text-6xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Ready for Statistical Analysis</h3>
                            <p class="text-gray-600">Select an analysis type and configure your parameters to begin.</p>
                        </div>

                        <!-- Results Container -->
                        <div id="resultsContainer" class="hidden">
                            <div class="flex justify-between items-center mb-6">
                                <h3 id="resultsTitle" class="text-lg font-medium text-gray-900"></h3>
                                <div class="flex space-x-2">
                                    <button id="exportResults" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                                        <i class="fas fa-download mr-2"></i>
                                        Export
                                    </button>
                                    <button id="generateReport" class="px-4 py-2 bg-emerald-500 text-white rounded-md hover:bg-emerald-600 transition-colors">
                                        <i class="fas fa-file-alt mr-2"></i>
                                        Generate Report
                                    </button>
                                </div>
                            </div>

                            <!-- Results Content -->
                            <div id="resultsContent" class="space-y-6">
                                <!-- Dynamic content will be inserted here -->
                            </div>
                        </div>

                        <!-- Error State -->
                        <div id="errorState" class="hidden text-center py-12">
                            <div class="mx-auto w-24 h-24 text-red-400 mb-4">
                                <i class="fas fa-exclamation-triangle text-6xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Analysis Error</h3>
                            <p id="errorMessage" class="text-gray-600"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Statistical Analysis JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const analysisType = document.getElementById('analysisType');
    const analysisOptions = document.getElementById('analysisOptions');
    const trendOptions = document.getElementById('trendOptions');
    const ttestOptions = document.getElementById('ttestOptions');
    const runAnalysisBtn = document.getElementById('runAnalysis');
    
    const loadingState = document.getElementById('loadingState');
    const initialState = document.getElementById('initialState');
    const resultsContainer = document.getElementById('resultsContainer');
    const errorState = document.getElementById('errorState');
    const resultsContent = document.getElementById('resultsContent');
    const resultsTitle = document.getElementById('resultsTitle');

    // Show/hide analysis-specific options
    analysisType.addEventListener('change', function() {
        const selectedType = this.value;
        
        // Hide all options first
        analysisOptions.classList.add('hidden');
        trendOptions.classList.add('hidden');
        ttestOptions.classList.add('hidden');
        
        // Show relevant options
        if (selectedType === 'trend') {
            analysisOptions.classList.remove('hidden');
            trendOptions.classList.remove('hidden');
        } else if (selectedType === 't_test') {
            analysisOptions.classList.remove('hidden');
            ttestOptions.classList.remove('hidden');
        }
    });

    // Run analysis
    runAnalysisBtn.addEventListener('click', function() {
        const selectedAnalysis = analysisType.value;
        
        if (!selectedAnalysis) {
            alert('Please select an analysis type');
            return;
        }

        // Show loading state
        showState('loading');

        // Collect filters
        const filters = {
            pollutant_types: Array.from(document.getElementById('pollutantFilter').selectedOptions).map(opt => opt.value),
            locations: Array.from(document.getElementById('locationFilter').selectedOptions).map(opt => opt.value),
            batches: Array.from(document.getElementById('batchFilter').selectedOptions).map(opt => opt.value),
            date_from: document.getElementById('dateFrom').value,
            date_to: document.getElementById('dateTo').value
        };

        // Prepare analysis parameters
        const analysisParams = {
            analysis_type: selectedAnalysis,
            filters: filters
        };

        // Add analysis-specific parameters
        if (selectedAnalysis === 'trend') {
            analysisParams.time_period = document.getElementById('timePeriod').value;
        } else if (selectedAnalysis === 't_test') {
            analysisParams.test_type = document.getElementById('testType').value;
        }

        // Run analysis
        fetch('{% url "run_statistical_analysis" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(analysisParams)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayResults(data.results, data.analysis_type);
            } else {
                showError(data.error);
            }
        })
        .catch(error => {
            console.error('Analysis error:', error);
            showError('An error occurred while running the analysis');
        });
    });

    function showState(state) {
        // Hide all states
        loadingState.classList.add('hidden');
        initialState.classList.add('hidden');
        resultsContainer.classList.add('hidden');
        errorState.classList.add('hidden');

        // Show selected state
        if (state === 'loading') {
            loadingState.classList.remove('hidden');
        } else if (state === 'initial') {
            initialState.classList.remove('hidden');
        } else if (state === 'results') {
            resultsContainer.classList.remove('hidden');
        } else if (state === 'error') {
            errorState.classList.remove('hidden');
        }
    }

    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        showState('error');
    }

    function displayResults(results, analysisType) {
        resultsTitle.textContent = getAnalysisTitle(analysisType);
        resultsContent.innerHTML = formatResults(results, analysisType);
        showState('results');
    }

    function getAnalysisTitle(analysisType) {
        const titles = {
            'descriptive': 'Descriptive Statistics Results',
            't_test': 'T-Test Analysis Results',
            'anova': 'ANOVA Analysis Results',
            'correlation': 'Correlation Analysis Results',
            'trend': 'Trend Analysis Results',
            'compliance': 'Compliance Analysis Results',
            'multivariate': 'Multivariate Analysis Results'
        };
        return titles[analysisType] || 'Analysis Results';
    }

    function formatResults(results, analysisType) {
        if (results.error) {
            return `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-red-800">${results.error}</p>
            </div>`;
        }

        let html = '';

        if (analysisType === 'descriptive') {
            html += formatDescriptiveResults(results);
        } else if (analysisType === 't_test') {
            html += formatTTestResults(results);
        } else if (analysisType === 'anova') {
            html += formatAnovaResults(results);
        } else if (analysisType === 'correlation') {
            html += formatCorrelationResults(results);
        } else if (analysisType === 'trend') {
            html += formatTrendResults(results);
        } else if (analysisType === 'compliance') {
            html += formatComplianceResults(results);
        } else if (analysisType === 'multivariate') {
            html += formatMultivariateResults(results);
        }

        return html;
    }

    function formatDescriptiveResults(results) {
        let html = '<div class="space-y-6">';
        
        // Overall statistics
        if (results.overall) {
            html += `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-medium text-blue-900 mb-2">Overall Summary</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-blue-700">Total Readings:</span>
                            <span class="font-medium">${results.overall.total_readings}</span>
                        </div>
                        <div>
                            <span class="text-blue-700">Locations:</span>
                            <span class="font-medium">${results.overall.unique_locations}</span>
                        </div>
                        <div>
                            <span class="text-blue-700">Pollutants:</span>
                            <span class="font-medium">${results.overall.unique_pollutants}</span>
                        </div>
                        <div>
                            <span class="text-blue-700">Date Range:</span>
                            <span class="font-medium">${results.overall.date_range.start} to ${results.overall.date_range.end}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // By pollutant statistics
        if (results.by_pollutant) {
            html += '<div class="bg-white border border-gray-200 rounded-lg overflow-hidden">';
            html += '<div class="bg-gray-50 px-4 py-2 border-b"><h4 class="font-medium text-gray-900">Statistics by Pollutant</h4></div>';
            html += '<div class="overflow-x-auto">';
            html += '<table class="min-w-full divide-y divide-gray-200">';
            html += '<thead class="bg-gray-50"><tr>';
            html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pollutant</th>';
            html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Count</th>';
            html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Mean</th>';
            html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Median</th>';
            html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Std Dev</th>';
            html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Min</th>';
            html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Max</th>';
            html += '</tr></thead><tbody class="divide-y divide-gray-200">';
            
            for (const [pollutant, stats] of Object.entries(results.by_pollutant)) {
                html += `<tr>
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">${pollutant}</td>
                    <td class="px-4 py-2 text-sm text-gray-600">${stats.count}</td>
                    <td class="px-4 py-2 text-sm text-gray-600">${stats.mean.toFixed(3)}</td>
                    <td class="px-4 py-2 text-sm text-gray-600">${stats.median.toFixed(3)}</td>
                    <td class="px-4 py-2 text-sm text-gray-600">${stats.std.toFixed(3)}</td>
                    <td class="px-4 py-2 text-sm text-gray-600">${stats.min.toFixed(3)}</td>
                    <td class="px-4 py-2 text-sm text-gray-600">${stats.max.toFixed(3)}</td>
                </tr>`;
            }
            
            html += '</tbody></table></div></div>';
        }

        html += '</div>';
        return html;
    }

    function formatTTestResults(results) {
        let html = '<div class="space-y-4">';
        
        for (const [pollutant, result] of Object.entries(results)) {
            if (result.error) continue;
            
            const significantClass = result.significant ? 'border-red-200 bg-red-50' : 'border-green-200 bg-green-50';
            const significantText = result.significant ? 'Significant Difference' : 'No Significant Difference';
            const significantColor = result.significant ? 'text-red-800' : 'text-green-800';
            
            html += `
                <div class="border ${significantClass} rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-medium text-gray-900">${pollutant}</h4>
                        <span class="px-2 py-1 text-xs font-medium ${significantColor} bg-white rounded">${significantText}</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-3">
                        <div>
                            <span class="text-gray-600">t-statistic:</span>
                            <span class="font-medium">${result.t_statistic.toFixed(4)}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">p-value:</span>
                            <span class="font-medium">${result.p_value.toFixed(4)}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Cohen's d:</span>
                            <span class="font-medium">${result.cohens_d.toFixed(3)}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Test:</span>
                            <span class="font-medium">${result.test_type}</span>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700">${result.interpretation}</p>
                </div>
            `;
        }
        
        html += '</div>';
        return html;
    }

    function formatAnovaResults(results) {
        let html = '<div class="space-y-4">';
        
        for (const [pollutant, result] of Object.entries(results)) {
            if (result.error) continue;
            
            const significantClass = result.significant ? 'border-red-200 bg-red-50' : 'border-green-200 bg-green-50';
            const significantText = result.significant ? 'Significant Difference' : 'No Significant Difference';
            const significantColor = result.significant ? 'text-red-800' : 'text-green-800';
            
            html += `
                <div class="border ${significantClass} rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-medium text-gray-900">${pollutant}</h4>
                        <span class="px-2 py-1 text-xs font-medium ${significantColor} bg-white rounded">${significantText}</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm mb-3">
                        <div>
                            <span class="text-gray-600">F-statistic:</span>
                            <span class="font-medium">${result.f_statistic.toFixed(4)}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">p-value:</span>
                            <span class="font-medium">${result.p_value.toFixed(4)}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">η² (eta-squared):</span>
                            <span class="font-medium">${result.eta_squared.toFixed(3)}</span>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700 mb-3">${result.interpretation}</p>
                    
                    <!-- Group Statistics -->
                    <div class="bg-white rounded border p-3">
                        <h5 class="font-medium text-gray-900 mb-2">Group Statistics</h5>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
                            ${result.group_stats.map(group => `
                                <div class="bg-gray-50 p-2 rounded">
                                    <div class="font-medium">${group.group_name}</div>
                                    <div>n=${group.n}, mean=${group.mean.toFixed(3)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        return html;
    }

    function formatTrendResults(results) {
        let html = '<div class="space-y-4">';
        
        for (const [pollutant, result] of Object.entries(results)) {
            if (result.error) continue;
            
            const trendClass = result.significant_trend ? 'border-blue-200 bg-blue-50' : 'border-gray-200 bg-gray-50';
            const trendText = result.significant_trend ? `Significant ${result.trend_direction} trend` : 'No significant trend';
            const trendColor = result.significant_trend ? 'text-blue-800' : 'text-gray-800';
            
            html += `
                <div class="border ${trendClass} rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-medium text-gray-900">${pollutant}</h4>
                        <span class="px-2 py-1 text-xs font-medium ${trendColor} bg-white rounded">${trendText}</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-3">
                        <div>
                            <span class="text-gray-600">Slope:</span>
                            <span class="font-medium">${result.slope.toFixed(6)}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">R²:</span>
                            <span class="font-medium">${result.r_squared.toFixed(3)}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">p-value:</span>
                            <span class="font-medium">${result.p_value.toFixed(4)}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Periods:</span>
                            <span class="font-medium">${result.n_periods}</span>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700">${result.interpretation}</p>
                </div>
            `;
        }
        
        html += '</div>';
        return html;
    }

    function formatComplianceResults(results) {
        let html = '<div class="space-y-4">';
        
        for (const [pollutant, standards] of Object.entries(results)) {
            html += `
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">${pollutant}</h4>
                    <div class="space-y-3">
            `;
            
            for (const [standard, data] of Object.entries(standards)) {
                const complianceClass = data.compliance_status === 'Compliant' ? 'text-green-800 bg-green-100' : 'text-red-800 bg-red-100';
                
                html += `
                    <div class="bg-gray-50 rounded p-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium text-gray-900">${standard.toUpperCase()} Standard</span>
                            <span class="px-2 py-1 text-xs font-medium ${complianceClass} rounded">${data.compliance_status}</span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                            <div>
                                <span class="text-gray-600">Standard:</span>
                                <span class="font-medium">${data.standard_value}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Exceedances:</span>
                                <span class="font-medium">${data.exceedances}/${data.total_measurements}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Rate:</span>
                                <span class="font-medium">${data.exceedance_rate_percent.toFixed(1)}%</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Max Factor:</span>
                                <span class="font-medium">${data.exceedance_factor.toFixed(2)}x</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div></div>';
        }
        
        html += '</div>';
        return html;
    }

    function formatCorrelationResults(results) {
        let html = '<div class="space-y-6">';
        
        // Pollutant correlations
        if (results.pollutant_correlations) {
            html += `
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">Pollutant Correlations</h4>
                    <div class="space-y-2">
            `;
            
            for (const [pair, corr] of Object.entries(results.pollutant_correlations)) {
                const strengthClass = corr.strength === 'strong' || corr.strength === 'very strong' ? 'text-blue-800' : 'text-gray-600';
                const significantClass = corr.significant ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200';
                
                html += `
                    <div class="border ${significantClass} rounded p-3">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${pair.replace('_vs_', ' vs ')}</span>
                            <span class="text-sm ${strengthClass}">${corr.strength} (r=${corr.correlation_coefficient.toFixed(3)})</span>
                        </div>
                        <div class="text-xs text-gray-600 mt-1">
                            p=${corr.p_value.toFixed(4)}, n=${corr.n_observations}
                        </div>
                    </div>
                `;
            }
            
            html += '</div></div>';
        }
        
        // Environmental correlations
        if (results.environmental_correlations) {
            html += `
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">Environmental Factor Correlations</h4>
                    <div class="space-y-3">
            `;
            
            for (const [pollutant, factors] of Object.entries(results.environmental_correlations)) {
                html += `<div class="bg-gray-50 rounded p-3">
                    <h5 class="font-medium text-gray-900 mb-2">${pollutant}</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                `;
                
                for (const [factor, corr] of Object.entries(factors)) {
                    const strengthClass = corr.strength === 'strong' || corr.strength === 'very strong' ? 'text-blue-800' : 'text-gray-600';
                    
                    html += `
                        <div class="text-sm">
                            <span class="font-medium">${factor}:</span>
                            <span class="${strengthClass}">r=${corr.correlation_coefficient.toFixed(3)} (${corr.strength})</span>
                        </div>
                    `;
                }
                
                html += '</div></div>';
            }
            
            html += '</div></div>';
        }
        
        html += '</div>';
        return html;
    }

    function formatMultivariateResults(results) {
        let html = '<div class="space-y-6">';
        
        // PCA Results
        if (results.pca) {
            html += `
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">Principal Component Analysis</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h5 class="font-medium text-gray-700 mb-2">Explained Variance</h5>
                            <div class="text-sm space-y-1">
                                ${results.pca.explained_variance_ratio.slice(0, 5).map((variance, i) => 
                                    `<div>PC${i+1}: ${(variance * 100).toFixed(1)}%</div>`
                                ).join('')}
                            </div>
                        </div>
                        <div>
                            <h5 class="font-medium text-gray-700 mb-2">Summary</h5>
                            <div class="text-sm">
                                <div>Components for 95% variance: ${results.pca.n_components_95_variance}</div>
                                <div>Total features: ${results.pca.feature_names.length}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Clustering Results
        if (results.clustering) {
            html += `
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">K-Means Clustering</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h5 class="font-medium text-gray-700 mb-2">Cluster Information</h5>
                            <div class="text-sm">
                                <div>Optimal clusters: ${results.clustering.optimal_k}</div>
                                <div>Inertia: ${results.clustering.inertia.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        return html;
    }

    // Export and report generation
    document.getElementById('exportResults').addEventListener('click', function() {
        // Implementation for exporting results
        alert('Export functionality will be implemented');
    });

    document.getElementById('generateReport').addEventListener('click', function() {
        // Implementation for generating reports
        alert('Report generation functionality will be implemented');
    });
});
</script>
{% endblock %}