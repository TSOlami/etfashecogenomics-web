{% extends 'base.html' %}
{% load static %}

{% block title %}Reports - EcoGenomics Suite{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="etfash-logo">
                        <img src="{% static 'images/etfash-logo.jpeg' %}" alt="ETfash Logo" class="w-full h-full rounded-lg">
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold brand-text">EcoGenomics Suite</h1>
                        <p class="text-sm text-gray-600">Report Generation</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">Welcome, {{ user.username }}</span>
                    <a href="{% url 'dashboard' %}" class="text-emerald-600 hover:text-emerald-700 text-sm font-medium">Dashboard</a>
                    <a href="{% url 'logout' %}" class="text-gray-600 hover:text-gray-700 text-sm">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Breadcrumb -->
        <nav class="flex mb-8" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="{% url 'dashboard' %}" class="text-gray-700 hover:text-emerald-600 inline-flex items-center">
                        <i class="fas fa-home w-4 h-4 mr-2"></i>
                        Dashboard
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 w-4 h-4"></i>
                        <span class="ml-1 text-gray-500 md:ml-2">Reports</span>
                    </div>
                </li>
            </ol>
        </nav>

        <!-- Report Generation Interface -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Report Configuration -->
            <div class="lg:col-span-1">
                <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                    <div class="px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-500">
                        <h2 class="text-xl font-semibold text-white flex items-center">
                            <i class="fas fa-file-alt mr-3"></i>
                            Report Configuration
                        </h2>
                    </div>

                    <div class="p-6 space-y-6">
                        <!-- Report Type Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Report Type</label>
                            <select id="reportType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="comprehensive">Comprehensive Environmental Report</option>
                                <option value="compliance">Compliance Assessment Report</option>
                                <option value="statistical">Statistical Analysis Report</option>
                                <option value="spatial">Spatial Analysis Report</option>
                                <option value="temporal">Temporal Trends Report</option>
                                <option value="summary">Executive Summary Report</option>
                            </select>
                        </div>

                        <!-- Data Filters -->
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Data Selection</h3>
                            
                            <!-- Pollutants Filter -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pollutants</label>
                                <select id="pollutantFilter" multiple class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500" size="4">
                                    {% for pollutant in pollutants %}
                                        <option value="{{ pollutant.id }}">{{ pollutant.name }}</option>
                                    {% endfor %}
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
                            </div>

                            <!-- Locations Filter -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Locations</label>
                                <select id="locationFilter" multiple class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500" size="4">
                                    {% for location in locations %}
                                        <option value="{{ location.id }}">{{ location.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Date Range Filter -->
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                                    <input type="date" id="dateFrom" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                                    <input type="date" id="dateTo" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                            </div>

                            <!-- Batches Filter -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sample Batches</label>
                                <select id="batchFilter" multiple class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500" size="3">
                                    {% for batch in batches %}
                                        <option value="{{ batch.id }}">{{ batch.name }} ({{ batch.sampling_date }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Report Options -->
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Report Options</h3>
                            
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <input type="checkbox" id="includeCharts" checked class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                    <label for="includeCharts" class="ml-2 text-sm text-gray-700">Include Charts and Visualizations</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="includeStatistics" checked class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                    <label for="includeStatistics" class="ml-2 text-sm text-gray-700">Include Statistical Analysis</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="includeCompliance" checked class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                    <label for="includeCompliance" class="ml-2 text-sm text-gray-700">Include Compliance Assessment</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="includeRecommendations" checked class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                    <label for="includeRecommendations" class="ml-2 text-sm text-gray-700">Include Recommendations</label>
                                </div>
                            </div>
                        </div>

                        <!-- Generate Report Button -->
                        <button id="generateReport" class="w-full px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-md hover:from-green-600 hover:to-emerald-600 transition-colors flex items-center justify-center">
                            <i class="fas fa-file-alt mr-2"></i>
                            Generate Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Display -->
            <div class="lg:col-span-2">
                <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                    <div class="px-6 py-4 bg-gradient-to-r from-emerald-500 to-cyan-500">
                        <h2 class="text-xl font-semibold text-white flex items-center">
                            <i class="fas fa-file-contract mr-3"></i>
                            Generated Report
                        </h2>
                    </div>

                    <div class="p-6">
                        <!-- Loading State -->
                        <div id="loadingState" class="hidden text-center py-12">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500"></div>
                            <p class="mt-4 text-gray-600">Generating comprehensive report...</p>
                        </div>

                        <!-- Initial State -->
                        <div id="initialState" class="text-center py-12">
                            <div class="mx-auto w-24 h-24 text-gray-400 mb-4">
                                <i class="fas fa-file-alt text-6xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Ready to Generate Reports</h3>
                            <p class="text-gray-600">Configure your report parameters and click generate to create a comprehensive environmental monitoring report.</p>
                        </div>

                        <!-- Report Container -->
                        <div id="reportContainer" class="hidden">
                            <div class="flex justify-between items-center mb-6">
                                <h3 id="reportTitle" class="text-lg font-medium text-gray-900"></h3>
                                <div class="flex space-x-2">
                                    <button id="exportPDF" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                                        <i class="fas fa-file-pdf mr-2"></i>
                                        Export PDF
                                    </button>
                                    <button id="exportExcel" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                                        <i class="fas fa-file-excel mr-2"></i>
                                        Export Excel
                                    </button>
                                    <button id="exportJSON" class="px-4 py-2 bg-emerald-500 text-white rounded-md hover:bg-emerald-600 transition-colors">
                                        <i class="fas fa-download mr-2"></i>
                                        Export JSON
                                    </button>
                                </div>
                            </div>

                            <!-- Report Content -->
                            <div id="reportContent" class="space-y-6 max-h-96 overflow-y-auto">
                                <!-- Dynamic content will be inserted here -->
                            </div>
                        </div>

                        <!-- Error State -->
                        <div id="errorState" class="hidden text-center py-12">
                            <div class="mx-auto w-24 h-24 text-red-400 mb-4">
                                <i class="fas fa-exclamation-triangle text-6xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Report Generation Error</h3>
                            <p id="errorMessage" class="text-gray-600"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Report Generation JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateReport');
    
    const loadingState = document.getElementById('loadingState');
    const initialState = document.getElementById('initialState');
    const reportContainer = document.getElementById('reportContainer');
    const errorState = document.getElementById('errorState');
    const reportContent = document.getElementById('reportContent');
    const reportTitle = document.getElementById('reportTitle');

    let currentReportData = null;

    // Generate report
    generateBtn.addEventListener('click', function() {
        // Show loading state
        showState('loading');

        // Collect filters
        const filters = {
            pollutant_types: Array.from(document.getElementById('pollutantFilter').selectedOptions).map(opt => opt.value),
            locations: Array.from(document.getElementById('locationFilter').selectedOptions).map(opt => opt.value),
            batches: Array.from(document.getElementById('batchFilter').selectedOptions).map(opt => opt.value),
            date_from: document.getElementById('dateFrom').value,
            date_to: document.getElementById('dateTo').value
        };

        // Collect report options
        const reportParams = {
            filters: filters,
            include_charts: document.getElementById('includeCharts').checked,
            include_statistics: document.getElementById('includeStatistics').checked,
            include_compliance: document.getElementById('includeCompliance').checked,
            include_recommendations: document.getElementById('includeRecommendations').checked
        };

        // Generate report
        fetch('{% url "generate_report" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(reportParams)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentReportData = data.report;
                displayReport(data.report);
            } else {
                showError(data.error);
            }
        })
        .catch(error => {
            console.error('Report generation error:', error);
            showError('An error occurred while generating the report');
        });
    });

    function showState(state) {
        // Hide all states
        loadingState.classList.add('hidden');
        initialState.classList.add('hidden');
        reportContainer.classList.add('hidden');
        errorState.classList.add('hidden');

        // Show selected state
        if (state === 'loading') {
            loadingState.classList.remove('hidden');
        } else if (state === 'initial') {
            initialState.classList.remove('hidden');
        } else if (state === 'report') {
            reportContainer.classList.remove('hidden');
        } else if (state === 'error') {
            errorState.classList.remove('hidden');
        }
    }

    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        showState('error');
    }

    function displayReport(report) {
        if (report.error) {
            showError(report.error);
            return;
        }

        reportTitle.textContent = report.title || 'Environmental Monitoring Report';
        reportContent.innerHTML = formatReport(report);
        showState('report');
    }

    function formatReport(report) {
        let html = '';

        // Report Header
        html += `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-blue-900 mb-2">${report.title}</h2>
                <p class="text-blue-700">Generated on: ${new Date(report.generated_at).toLocaleString()}</p>
                <p class="text-blue-700">Report Period: ${report.period?.start_date} to ${report.period?.end_date}</p>
            </div>
        `;

        // Executive Summary
        if (report.executive_summary) {
            html += `
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Executive Summary</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-emerald-600">${report.executive_summary.total_readings}</div>
                            <div class="text-sm text-gray-600">Total Readings</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${report.executive_summary.unique_locations}</div>
                            <div class="text-sm text-gray-600">Locations</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">${report.executive_summary.unique_pollutants}</div>
                            <div class="text-sm text-gray-600">Pollutants</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600">${report.executive_summary.compliance_issues?.length || 0}</div>
                            <div class="text-sm text-gray-600">Compliance Issues</div>
                        </div>
                    </div>
                    <p class="text-gray-700">${report.executive_summary.overall_assessment}</p>
                </div>
            `;
        }

        // Key Findings
        if (report.executive_summary?.key_findings) {
            html += `
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-yellow-900 mb-4">Key Findings</h3>
                    <ul class="space-y-2">
                        ${report.executive_summary.key_findings.map(finding => 
                            `<li class="flex items-start">
                                <i class="fas fa-check-circle text-yellow-600 mt-1 mr-2"></i>
                                <span class="text-yellow-800">${finding}</span>
                            </li>`
                        ).join('')}
                    </ul>
                </div>
            `;
        }

        // Compliance Analysis
        if (report.compliance_analysis) {
            html += `
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Compliance Analysis</h3>
                    <div class="space-y-4">
            `;
            
            for (const [pollutant, standards] of Object.entries(report.compliance_analysis)) {
                html += `
                    <div class="border border-gray-100 rounded p-4">
                        <h4 class="font-medium text-gray-900 mb-3">${pollutant}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                `;
                
                for (const [standard, data] of Object.entries(standards)) {
                    const statusClass = data.compliance_status === 'Compliant' ? 'text-green-800 bg-green-100' : 'text-red-800 bg-red-100';
                    html += `
                        <div class="text-center">
                            <div class="text-sm font-medium text-gray-600">${standard.toUpperCase()}</div>
                            <div class="text-lg font-bold">${data.exceedance_rate_percent.toFixed(1)}%</div>
                            <div class="text-xs ${statusClass} px-2 py-1 rounded">${data.compliance_status}</div>
                        </div>
                    `;
                }
                
                html += '</div></div>';
            }
            
            html += '</div></div>';
        }

        // Recommendations
        if (report.recommendations) {
            html += `
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-green-900 mb-4">Recommendations</h3>
                    <div class="space-y-3">
                        ${report.recommendations.map(rec => `
                            <div class="flex items-start">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                    rec.priority === 'High' ? 'bg-red-100 text-red-800' :
                                    rec.priority === 'Medium' ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-blue-100 text-blue-800'
                                } mr-3 mt-1">${rec.priority}</span>
                                <div>
                                    <div class="font-medium text-green-900">${rec.recommendation}</div>
                                    <div class="text-sm text-green-700">${rec.details}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Visualizations
        if (report.visualizations) {
            html += `
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Data Visualizations</h3>
                    <p class="text-gray-600">Interactive charts and maps are included in the full report export.</p>
                </div>
            `;
        }

        return html;
    }

    // Export functionality
    document.getElementById('exportPDF').addEventListener('click', function() {
        if (!currentReportData) return;
        
        fetch('{% url "export_report" format="pdf" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({report: currentReportData})
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'environmental_report.pdf';
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('PDF export error:', error);
            alert('PDF export is not yet implemented');
        });
    });

    document.getElementById('exportExcel').addEventListener('click', function() {
        if (!currentReportData) return;
        
        fetch('{% url "export_report" format="excel" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({report: currentReportData})
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'environmental_report.xlsx';
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Excel export error:', error);
            alert('Excel export is not yet implemented');
        });
    });

    document.getElementById('exportJSON').addEventListener('click', function() {
        if (!currentReportData) return;
        
        fetch('{% url "export_report" format="json" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({report: currentReportData})
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'environmental_report.json';
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('JSON export error:', error);
            alert('An error occurred during export');
        });
    });
});
</script>
{% endblock %}